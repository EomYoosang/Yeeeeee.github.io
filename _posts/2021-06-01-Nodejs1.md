---
title: NodeJS 1
description:
categories:
 - nodejs
tags:
---

# 핵심 개념

# 노드란?

node.jsⓇ은 Chrome V8 Javascript 엔진으로 빌드된 Javascript 런타임

서버와 런타임은?

### 서버

노드를 통해 자바스크립트 앱 실행, 서버 앱을 실행하는데 가장 많이 사용

서버는 네트워크를 통해 클라이언트에 정보, 서비스를 제공하는 컴퓨터or 프로그램

클라이언트

- 요청을 보내는 주체

- 브라우저, 데스크톱 프로그램, 모바일 앱, 다른 서버에 요청을 보내는 서버

  <img src="https://thebook.io/img/080229/025.jpg" width="70%">

웹사이트를 생각해보면?

사이트주소 입력(요청)->서버는 웹사이트 페이지를 보냄(응답)

### 런타임

런타임은 특정 언어로 만든 프로그램들을 실행할 수 있는 환경

노드: 자바스크립트 런타임=>자바스크립트 프로그램 실행

#### 짤막한 역사

기존에는 자바스크립트 프로그램을 웹 브라우저 위에서만 실행, 브라우저 외의 환경은 속도때문에 사용X

2008년 구글이 V8 엔진 사용하여 크롬 출시, 속도 문제 해결

2009년 Ryan Dahl은 V8 엔진 기반의 노드프로젝트 시작

#### 노드 내부 구조

<img src="https://thebook.io/img/080229/027_1.jpg" width="60%">

노드는 libuv, V8 라이브러리 사용

C, C++로 구현

##### libuv

노드의 특성인 이벤트기반, 논 블로킹 I/O 모델 구현

## 이벤트 기반

이벤트 기반이란 이벤트가 발생할 떄 미리 지정해둔 작업을 수행하는 방식

이벤트로는 클릭이나 네트워크 요청

### 이벤트 리스너

이벤트 리스너에 콜백 함수 등록

ex) 클릭 이벤트 리스너에 경고창 콜백 함수, 클릭 => 경고창

이벤트가 없거나 이벤트를 다 처리하면 대기

<img src="https://thebook.io/img/080229/027_2.jpg" width="60%">

### 이벤트 루프

호출한 함수를 호출 스택에 넣음 => 실행시 호출 스택에서 지워짐

아래 예시는?

```	javascript
function run() {
  console.log('3초 후 실행');
}
console.log('시작');
setTimeout(run, 3000);
console.log('끝');
```

호출 스택으로 설명하기 어려움

이벤트 루프, 백그라운드, 테스크 큐를 통해 설명

- __이벤트 루프__: 이벤트 발생 시 호출할 콜백 함수들을 관리하고, 호출된 콜백 함수의 실행 순서를 결정하는 역할을 담당. 노드가 종료될 때 까지 작업 반복하므로 루프(loop)라 부름.
- __백그라운드__: 타이머나 이벤트 리스너들이 대기, js가 아닌 다른 언어로 작성된 프로그램이라고 봐도 무방. 여러 작업 동시에 실행.
- __태스크 큐__: 이벤트 발생하면 __백그라운드__는 __태스크 큐__로 콜백 함수를 보냄. 콜백들이 줄을 서있어 __콜백 큐__라고도 함.

위 코드의 실행 과정은 다음과 같음

<img src="https://thebook.io/img/080229/030.jpg" width="70%">

<img src="https://thebook.io/img/080229/031_1.jpg" width="70%">

<img src="https://thebook.io/img/080229/031_2.jpg" width="70%">

1. anonymous, setTimeout()순으로 호출 스택에 들어감.

2. SetTimeout() 먼저 실행, Run은 백그라운드로 보냄, SetTimeout() 호출 스택에서 빠짐.

3. anonymous 호출 스택에서 빠짐.

4. 백그라운드에서 3초 후  run함수를 테스크 큐로 보냄

5. 호출 스택이 비어있으면 태스크 큐에서 함수를 하나씩 가져와 호출 스택에 넣고 실행

6. run()을 호출 스택으로 올리고 실행, run()이 호출 스택에서 비워짐

**호출 스택에 함수가 많으면 3초후에 실행 X**

**SetTimeout()이 정확하지 않을 수 있는 이유**

## 논 블로킹 I/O

기본적으로 자바스크립트 코드는 동시 실행 X

**자바스크립트상에서 돌아가는 것이 아닌 I/O는 동시 처리 가능**

- **논 블로킹**: 이전 작업이 완료될 때까지 대기하지 않고 다음 작업 수행
- **블로킹**: 이전 작업이 끝나야만 다음 작업 수행

작업이 모두 동시에 처리될 수 있을 경우 논 블로킹이 빠름

**논 블로킹으로 코딩하는 습관 중요**

## 싱글 스레드

자바스크립트의 엔진은 싱글 스레드이므로 코드 동시 실행X

**현실에서는 독립적으로 실행되지 않고, 브라우저나 nodejs같은 멀티스레드 환경에 임베디드되어 실행**

<img src="https://thebook.io/img/080229/035.jpg" width="60%">

노드는 엄밀히 말하면 싱글 스레드로 동작X

노드를 실행하면 프로세스 하나 생성, 프로세스에서 스레드들을 생성

 **그중 직접 제어할 수 있는 스레드는 하나=>노드가 싱글 스레드로 여겨지는 이유**



``` 
스레드풀은 노드가 특정 동작을 수행할 때 멀티 스레드를 사용 (ex. 암호화, 파일 입출력, 압축)

워커 스레드는 노드 12 버전에서 안정화된 기능으로 이제 노드에서도 멀티 스레드를 사용. CPU 작업이 많은 경우 워커 스레드를 사용
```

멀티 스레딩과 멀티 프로세싱

| 멀티 스레딩                                  | 멀티 프로세싱            |
| -------------------------------------------- | ------------------------ |
| 하나의 프로세스 안에서 여러 개의 스레드 사용 | 여러개의 프로세스 사용   |
| CPU 작업이 많을 때 사용                      | I/O요청이 많을 때 사용   |
| 프로그래밍이 어려움                          | 프로그래밍이 비교적 쉬움 |